<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prolific Performance Dashboard</title>
    <!-- Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0e1117;
            --card-bg: #161b22;
            --border-color: #30363d;
            --text-color: #ffffff;
            --accent-green: #2ea043;
            --accent-blue: #3498db;
            --accent-teal: #00d1b2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1, h2, h3 { margin-bottom: 10px; font-weight: 600; }
        h1 { text-align: center; margin-bottom: 30px; }

        /* File Upload */
        .upload-section {
            background: var(--card-bg);
            border: 2px dashed var(--border-color);
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        input[type="file"] {
            color: white;
        }

        /* Metric Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
        }
        .metric-label { font-size: 0.9em; color: #8b949e; }
        .metric-value { font-size: 1.8em; font-weight: bold; margin-top: 5px; }
        .metric-delta { font-size: 0.9em; margin-top: 5px; }
        .delta-pos { color: var(--accent-green); }
        .delta-neg { color: #f85149; }

        /* Layout Columns */
        .col-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 768px) { .col-2 { grid-template-columns: 1fr; } }

        /* Controls */
        .controls {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        select, input[type="date"], input[type="text"] {
            background: #0d1117;
            border: 1px solid var(--border-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        th { color: #8b949e; }
        tr:last-child td { border-bottom: none; }

        /* Utility */
        .hidden { display: none; }
        .divider { border-bottom: 1px solid var(--border-color); margin: 40px 0; }
        
        .section-header { margin-top: 0; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚ö° Prolific Performance Dashboard</h1>

    <!-- Upload Section -->
    <div class="upload-section" id="uploadSection">
        <h3>Upload your history.csv</h3>
        <p style="color: #8b949e; margin-bottom: 20px;">Data is processed locally in your browser. No data is sent to any server.</p>
        <input type="file" id="csvFile" accept=".csv" />
    </div>

    <!-- Dashboard Content (Hidden until load) -->
    <div id="dashboard" class="hidden">
        
        <!-- KPIs -->
        <div class="metrics-grid" id="kpi-container">
            <!-- Populated by JS -->
        </div>

        <h3>üèÅ Daily Duel</h3>
        <div class="col-2" id="duel-container">
            <!-- Populated by JS -->
        </div>

        <div class="divider"></div>

        <!-- TIMELINE SECTION -->
        <h3 class="section-header">üìà Earnings Timeline</h3>
        <div class="controls">
            <div>
                <label>View By:</label>
                <select id="timeGranularity">
                    <option value="Daily">Daily</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Monthly" selected>Monthly</option>
                    <option value="Yearly">Yearly</option>
                </select>
            </div>
            <div>
                <label>From:</label>
                <input type="date" id="dateStart">
            </div>
            <div>
                <label>To:</label>
                <input type="date" id="dateEnd">
            </div>
        </div>
        <div id="chartTimeline" style="width:100%; height:400px;"></div>

        <div class="divider"></div>

        <!-- Top Weeks / Months -->
        <div class="col-2">
            <div>
                <h3>üóìÔ∏è Top 10 Weeks</h3>
                <div class="table-wrapper">
                    <table id="tableWeeks"></table>
                </div>
            </div>
            <div>
                <h3>üìÖ Monthly Rankings</h3>
                <div class="table-wrapper">
                    <table id="tableMonths"></table>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- Efficiency Charts -->
        <div class="col-2">
            <div>
                <h3>üóìÔ∏è Avg. Hourly Pay by Weekday</h3>
                <div id="chartWeekday" style="height:350px;"></div>
            </div>
            <div>
                <h3>üïí Avg. Hourly Pay by Hour</h3>
                <div id="chartHour" style="height:350px;"></div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- Search -->
        <h3 class="section-header">üîç Keyword Analysis</h3>
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Search keywords (e.g., 'AI', 'Game')" style="width: 300px;">
            <span id="searchStats" style="margin-left: 15px; font-weight: bold;"></span>
        </div>
        <div class="table-wrapper hidden" id="searchTableWrapper">
            <table id="tableSearch"></table>
        </div>

        <div class="divider"></div>

        <!-- Top 10 Lists -->
        <div class="col-2">
            <div>
                <h3>üí∞ Top 10 by Reward</h3>
                <div class="table-wrapper">
                    <table id="tableTopReward"></table>
                </div>
            </div>
            <div>
                <h3>üöÄ Top 10 by Hourly Rate</h3>
                <div class="table-wrapper">
                    <table id="tableTopWage"></table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// --- Global Data Store ---
let fullData = [];
let cleanData = []; // Filtered for outliers
let currencyRate = 1.30; 

// --- Helper Functions ---
const parseMoney = (val) => {
    if (typeof val !== 'string') return 0;
    return parseFloat(val.replace(/[¬£$,]/g, '')) || 0;
};

const formatDate = (date) => date.toISOString().split('T')[0];

const getWeekNumber = (d) => {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
    return `${d.getUTCFullYear()}-W${weekNo.toString().padStart(2, '0')}`;
};

// --- Main Process Logic ---
document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            processData(results.data);
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }
    });
});

function processData(rawData) {
    // 1. Clean and Transform
    fullData = rawData
        .filter(row => row['Status'] && (row['Status'].includes('APPROVED') || row['Status'].includes('AWAITING REVIEW')))
        .map(row => {
            const startedAt = new Date(row['Started At']);
            const completedAt = new Date(row['Completed At']);
            
            // Money parsing
            const rewardRaw = parseMoney(row['Reward']);
            const bonusRaw = parseMoney(row['Bonus']);
            const totalRaw = rewardRaw + bonusRaw;
            
            // Currency conversion check
            const isGBP = row['Reward'] && row['Reward'].includes('¬£');
            const totalUSD = isGBP ? totalRaw * currencyRate : totalRaw;

            // Time Calcs
            const durationMin = (completedAt - startedAt) / 1000 / 60;
            const usdPerHour = durationMin > 0 ? (totalUSD / (durationMin / 60)) : 0;

            return {
                ...row,
                startedAt: startedAt,
                date: startedAt.toISOString().split('T')[0],
                month: startedAt.toISOString().slice(0, 7), // YYYY-MM
                year: startedAt.getFullYear(),
                dayOfMonth: startedAt.getDate(),
                week: getWeekNumber(startedAt),
                weekday: startedAt.toLocaleDateString('en-US', { weekday: 'long' }),
                hour: startedAt.getHours(),
                totalUSD: totalUSD,
                durationMin: durationMin,
                usdPerHour: usdPerHour,
                studyName: row['Study']
            };
        });

    // 2. Create "Clean" dataset (outliers removed for efficiency stats)
    cleanData = fullData.filter(d => d.durationMin > 0.5 && d.usdPerHour < 150);

    // 3. Initialize Dashboard Components
    renderKPIs();
    initTimeline();
    renderTables();
    renderEfficiencyCharts();
    renderTopLists();
}

// --- Component: KPIs ---
function renderKPIs() {
    const totalEarnings = _.sumBy(fullData, 'totalUSD');
    const totalStudies = fullData.length;

    // Find current month stats
    const allMonths = [...new Set(fullData.map(d => d.month))].sort();
    const currentMonthStr = allMonths[allMonths.length - 1];
    const currentMonthData = fullData.filter(d => d.month === currentMonthStr);
    
    // Duel Logic
    const today = new Date(); // Use actual today or max date in data? Script uses max date logic.
    // Let's stick to script logic: Find max day in current month
    const maxDateInMonth = _.maxBy(currentMonthData, 'dayOfMonth');
    const dayToCheck = maxDateInMonth ? maxDateInMonth.dayOfMonth : 1;

    const valToday = _.sumBy(currentMonthData.filter(d => d.dayOfMonth === dayToCheck), 'totalUSD');

    // Last Month
    const lastMonthStr = allMonths.length > 1 ? allMonths[allMonths.length - 2] : null;
    const valLastMonth = lastMonthStr 
        ? _.sumBy(fullData.filter(d => d.month === lastMonthStr && d.dayOfMonth === dayToCheck), 'totalUSD')
        : 0;

    // Best Month
    const monthlySums = _(fullData).groupBy('month').map((items, month) => ({
        month, sum: _.sumBy(items, 'totalUSD')
    })).value();
    const bestMonth = _.maxBy(monthlySums, 'sum').month;
    const valBestMonth = _.sumBy(fullData.filter(d => d.month === bestMonth && d.dayOfMonth === dayToCheck), 'totalUSD');

    // Render Metrics
    const kpiHTML = `
        ${createMetricCard("Total Earnings", totalEarnings, "$")}
        ${createMetricCard("Total Studies", totalStudies, "")}
        ${createMetricCard(`Earnings ${currentMonthStr}`, _.sumBy(currentMonthData, 'totalUSD'), "$")}
        ${createMetricCard(`Studies ${currentMonthStr}`, currentMonthData.length, "")}
    `;
    document.getElementById('kpi-container').innerHTML = kpiHTML;

    // Render Duel
    const duelHTML = `
        ${createMetricCard(`Today vs Last Month (Day ${dayToCheck})`, valToday, "$", valLastMonth)}
        ${createMetricCard(`Today vs Record (Day ${dayToCheck})`, valToday, "$", valBestMonth)}
    `;
    document.getElementById('duel-container').innerHTML = duelHTML;
}

function createMetricCard(label, value, prefix, compareVal = null) {
    let deltaHTML = "";
    if (compareVal !== null) {
        const diff = value - compareVal;
        const pct = compareVal > 0 ? (diff / compareVal) * 100 : 0;
        const colorClass = diff >= 0 ? 'delta-pos' : 'delta-neg';
        deltaHTML = `<div class="metric-delta ${colorClass}">${diff >=0 ? '+' : ''}$${diff.toFixed(2)} (${pct.toFixed(1)}%)</div>`;
    }

    return `
        <div class="metric-card">
            <div class="metric-label">${label}</div>
            <div class="metric-value">${prefix}${value.toFixed(2)}</div>
            ${deltaHTML}
        </div>
    `;
}

// --- Component: Timeline Chart ---
function initTimeline() {
    // Set default dates
    const dates = fullData.map(d => d.startedAt.getTime());
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));

    const startInput = document.getElementById('dateStart');
    const endInput = document.getElementById('dateEnd');
    
    startInput.value = formatDate(minDate);
    endInput.value = formatDate(maxDate);

    // Event Listeners
    startInput.addEventListener('change', updateTimeline);
    endInput.addEventListener('change', updateTimeline);
    document.getElementById('timeGranularity').addEventListener('change', updateTimeline);

    updateTimeline();
}

function updateTimeline() {
    const granularity = document.getElementById('timeGranularity').value;
    const sDate = new Date(document.getElementById('dateStart').value);
    const eDate = new Date(document.getElementById('dateEnd').value);
    eDate.setHours(23, 59, 59); // End of day

    // Filter Date Range
    const timelineData = fullData.filter(d => d.startedAt >= sDate && d.startedAt <= eDate);

    // Grouping
    let grouped = {};
    
    timelineData.forEach(d => {
        let key;
        if (granularity === 'Daily') key = d.date;
        else if (granularity === 'Weekly') key = d.week;
        else if (granularity === 'Monthly') key = d.month;
        else key = d.year.toString();

        if (!grouped[key]) grouped[key] = 0;
        grouped[key] += d.totalUSD;
    });

    // Prepare for Plotly
    const keys = Object.keys(grouped).sort();
    const values = keys.map(k => grouped[k]);

    const trace = {
        x: keys,
        y: values,
        type: 'bar',
        marker: {
            color: values,
            colorscale: 'Greens'
        },
        text: values.map(v => '$' + v.toFixed(2)),
        textposition: 'auto',
        hoverinfo: 'x+y'
    };

    const layout = {
        title: { text: `${granularity} Earnings`, font: { color: 'white' } },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: { color: 'white', gridcolor: '#30363d' },
        yaxis: { color: 'white', gridcolor: '#30363d', title: 'USD ($)' },
        margin: { t: 40, l: 50, r: 20, b: 50 }
    };

    Plotly.newPlot('chartTimeline', [trace], layout, {responsive: true, displayModeBar: false});
}

// --- Component: Tables ---
function renderTables() {
    // Weeks
    const weeklyStats = _(fullData).groupBy('week').map((items, week) => ({
        label: week,
        total: _.sumBy(items, 'totalUSD'),
        hours: _.sumBy(items, 'durationMin') / 60,
        rate: _.meanBy(items, 'usdPerHour')
    })).orderBy(['total'], ['desc']).take(10).value();

    generateTable('tableWeeks', weeklyStats, ['Week', 'Total USD', 'Work Hours', 'Rate'], 
        row => `<td>${row.label}</td><td>$${row.total.toFixed(2)}</td><td>${row.hours.toFixed(1)} h</td><td>$${row.rate.toFixed(2)}/h</td>`
    );

    // Months
    const monthlyStats = _(fullData).groupBy('month').map((items, month) => ({
        label: month,
        total: _.sumBy(items, 'totalUSD'),
        hours: _.sumBy(items, 'durationMin') / 60,
        rate: _.meanBy(items, 'usdPerHour')
    })).orderBy(['total'], ['desc']).value();

    generateTable('tableMonths', monthlyStats, ['Month', 'Total USD', 'Work Hours', 'Rate'], 
        row => `<td>${row.label}</td><td>$${row.total.toFixed(2)}</td><td>${row.hours.toFixed(1)} h</td><td>$${row.rate.toFixed(2)}/h</td>`
    );
}

function generateTable(id, data, headers, rowMapper) {
    const table = document.getElementById(id);
    let html = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
    html += data.map(d => `<tr>${rowMapper(d)}</tr>`).join('');
    html += '</tbody>';
    table.innerHTML = html;
}

// --- Component: Efficiency Charts ---
function renderEfficiencyCharts() {
    // Weekday Bar
    const daysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const weekdayStats = _(cleanData).groupBy('weekday')
        .map((items, day) => ({ day, rate: _.meanBy(items, 'usdPerHour') }))
        .sort((a, b) => daysOrder.indexOf(a.day) - daysOrder.indexOf(b.day))
        .value();

    Plotly.newPlot('chartWeekday', [{
        x: weekdayStats.map(d => d.day),
        y: weekdayStats.map(d => d.rate),
        type: 'bar',
        marker: { color: '#3498db' }
    }], {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: { color: 'white' },
        yaxis: { color: 'white', title: '$/h' },
        margin: { t: 20, l: 40, r: 20, b: 40 }
    }, {responsive: true, displayModeBar: false});

    // Hourly Line
    const hourStats = _(cleanData).groupBy('hour')
        .map((items, h) => ({ hour: parseInt(h), rate: _.meanBy(items, 'usdPerHour') }))
        .orderBy(['hour'], ['asc'])
        .value();

    Plotly.newPlot('chartHour', [{
        x: hourStats.map(d => d.hour),
        y: hourStats.map(d => d.rate),
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#00d1b2' }
    }], {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        xaxis: { color: 'white', title: 'Hour of Day' },
        yaxis: { color: 'white', title: '$/h' },
        margin: { t: 20, l: 40, r: 20, b: 40 }
    }, {responsive: true, displayModeBar: false});
}

// --- Component: Search ---
document.getElementById('searchInput').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    const wrapper = document.getElementById('searchTableWrapper');
    const stats = document.getElementById('searchStats');

    if (query.length < 2) {
        wrapper.classList.add('hidden');
        stats.innerText = "";
        return;
    }

    const results = cleanData.filter(d => d.studyName.toLowerCase().includes(query));
    
    if (results.length > 0) {
        wrapper.classList.remove('hidden');
        const avgRate = _.meanBy(results, 'usdPerHour');
        stats.innerText = `Avg Rate: $${avgRate.toFixed(2)}/h (${results.length} found)`;
        
        generateTable('tableSearch', results.slice(0, 50), ['Study', 'Total USD', 'Rate', 'Date'],
            row => `<td>${row.studyName}</td><td>$${row.totalUSD.toFixed(2)}</td><td>$${row.usdPerHour.toFixed(2)}/h</td><td>${row.date}</td>`
        );
    } else {
        wrapper.classList.add('hidden');
        stats.innerText = "No results found.";
    }
});

// --- Component: Top 10 Lists ---
function renderTopLists() {
    // Top Reward
    const topReward = _.orderBy(fullData, ['totalUSD'], ['desc']).slice(0, 10);
    generateTable('tableTopReward', topReward, ['Study', 'Total USD', 'Rate'],
        row => `<td>${row.studyName.slice(0, 40)}...</td><td>$${row.totalUSD.toFixed(2)}</td><td>$${row.usdPerHour.toFixed(2)}/h</td>`
    );

    // Top Rate
    const topRate = _.orderBy(cleanData, ['usdPerHour'], ['desc']).slice(0, 10);
    generateTable('tableTopWage', topRate, ['Study', 'Rate', 'Total', 'Duration'],
        row => `<td>${row.studyName.slice(0, 40)}...</td><td>$${row.usdPerHour.toFixed(2)}/h</td><td>$${row.totalUSD.toFixed(2)}</td><td>${row.durationMin.toFixed(1)} m</td>`
    );
}

</script>
</body>
</html>